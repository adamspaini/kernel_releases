name: Build and Release PixelOS ROM

on: workflow_dispatch:

jobs: PixelOS: runs-on: ubuntu-latest defaults: run: shell: bash working-directory: ${{ github.workspace }}

steps:
  - name: Cleanup
    run: rm -rf ${{ github.workspace }}/*

  - name: Install Dependencies
    run: |
      sudo apt-get update -y
      sudo apt-get install -y bc bison build-essential curl flex git gnupg gperf libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush schedtool squashfs-tools xsltproc zip zlib1g-dev gcc-multilib g++-multilib lib32z1-dev liblz4-tool libncurses5 python3 python3-pip openjdk-17-jdk repo libtinfo5 unzip p7zip-full neofetch
      neofetch

  - name: Setup Swap
    run: |
      sudo fallocate -l 16G /swapfile
      sudo chmod 600 /swapfile
      sudo mkswap /swapfile
      sudo swapon --priority 10 /swapfile

  - name: Initialize ROM Source
    run: |
      git config --global user.name "YourName"
      git config --global user.email "your@email.com"
      mkdir rom && cd rom
      repo init -u https://github.com/PixelOS-AOSP/manifest -b fourteen --depth=1

  - name: Sync ROM Source
    run: |
      cd rom
      repo sync -c --no-clone-bundle --no-tags -j4

  - name: Clone Device Trees
    run: |
      cd rom
      git clone https://github.com/PixelOS-AOSP/device_xiaomi_vayu.git device/xiaomi/vayu
      git clone https://github.com/PixelOS-AOSP/kernel_xiaomi_sm8150.git kernel/xiaomi/sm8150
      git clone https://github.com/TheMuppets/proprietary_vendor_xiaomi.git vendor/xiaomi

  - name: Build ROM
    run: |
      cd rom
      source build/envsetup.sh
      lunch aosp_vayu-userdebug
      mka bacon -j$(nproc)

  - name: Find ROM ZIP
    run: |
      cd rom
      zip_file=$(find out/target/product/vayu -iname '*.zip' -print -quit)
      echo "ZIP_FILE=$zip_file" >> $GITHUB_ENV
      echo "ZIP_NAME=$(basename $zip_file .zip)" >> $GITHUB_ENV

  - name: Check ZIP file exists
    run: |
      if [ ! -f "${{ env.ZIP_FILE }}" ]; then
        echo "ROM ZIP no encontrado: ${{ env.ZIP_FILE }}"
        exit 1
      fi

  - name: Upload ROM to Releases
    uses: softprops/action-gh-release@v1
    with:
      files: ${{ env.ZIP_FILE }}
      name: ${{ env.ZIP_NAME }}
      tag_name: ${{ github.run_id }}
      body: |
        PixelOS for vayu
        Compiled automatically with GitHub Actions.
        Android 14 - Pixel experience

  - name: Cleanup Swap
    if: always()
    run: |
      sudo swapoff /swapfile || true
      sudo rm -f /swapfile || true
